<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vesper</title>
    <script src="{{ url_for('static', filename='cytoscape.min.js') }}"></script>
</head>
<body>
    <h1>Vesper</h1>
    <form id = "wcspForm">
        <label for="inp">Molecule name (eg. H2O, NaCl):</label>
        <input type="text" id="inp" name="inp" required>
        <br>
        <label for="type">Is it covalent or ionic?:</label>
        <input type="text" id="type" name="type" required>
        <br>
        <button type="submit">Submit</button>
    </form>
    <div id="output"></div>
    <div id="cy" style="width: 300px; height: 300px; border: 1px solid black; display: block"></div>
    <script>
        document.getElementById('wcspForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(this);
            fetch('/run_code', {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('output').textContent = 'Output: ' + data.output;
                var num_vars = data.num_vars;
                var input = data.output;
                var elements = renameDuplicates(data.elements);
                var graph = parseInput(input, num_vars, elements);
                var cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: graph.nodes.concat(graph.edges),
                    style: [
                        {
                            selector: 'node',
                            style: {
                                'label': 'data(label)',
                                'background-color': '#61bffc',
                                'text-valign': 'center',
                                'text-halign': 'center',
                                'shape': 'ellipse',
                                'width': 40,
                                'height': 40,
                                'font-size': 12,
                                'border-width': 2,
                                'border-color': '#333'
                            }
                        },
                        {
                            selector: 'edge',
                            style: {
                                'label': 'data(label)',
                                'line-color': '#ccc',
                                'width': 3,
                                'target-arrow-shape': 'triangle',
                                'target-arrow-color': '#ccc',
                                'curve-style': 'bezier',
                                'text-margin-y': -10,
                                'font-size': 10,
                            }
                        }
                    ],
                    layout: {
                        name: 'grid',
                        rows: Math.ceil(Math.sqrt(elements.length)),
                    }
                });
            })
            .catch((error) => {
                document.getElementById('output').textContent = 'Error: ' + error.message;
            });
        });
        
        function renameDuplicates(list) {
            const result = [];
            const counts = {};

            for (const element of list) {
                if (counts[element]) {
                    counts[element]++;
                    result.push(`${element}${counts[element]}`);
                } else {
                    counts[element] = 1;
                    result.push(element);
                }
            }
            return result;
        }

        function parseInput(input, num_vars, elements) {
            let values = input.substring(16, num_vars * 2 + 14);
            console.log(values);
            let numVals = values.split(' ').map(Number);
            console.log(numVals);
            let lonePairs = numVals.slice(0, elements.length);
            console.log(lonePairs);
            let bonds = numVals.slice(elements.length);
            console.log(bonds);
            
            let nodes = [];
            for (let i = 0; i < elements.length; i++) {
                nodes.push({
                    data: {
                        id: elements[i],
                        label: `${elements[i]} (${lonePairs[i]} Lone Pairs)`
                    },
                    position: {
                        x: 100 + i * 100,
                        y: 200
                    }
                });
            }
            console.log(nodes);
            let edges = [];
            let bondIndex = 0;
            for (let i = 0; i < elements.length; i++) {
                for (let j = i + 1; j < elements.length; j++) {
                    let bond = bonds[bondIndex];
                    bondIndex++;
                    if (bond > 0) {
                        edges.push({
                            data: {
                                source: elements[i],
                                target: elements[j],
                                label: bond === 2 ? 'Single Bond' : bond === 4 ? 'Double Bond' : 'Unknown Bond'
                            }
                        });
                    }
                }
            }
            console.log(edges);
            return { nodes, edges };
        }
    </script>    
</body>
</html>